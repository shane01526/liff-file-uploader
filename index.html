// ç°¡åŒ–ç‰ˆå‰ç«¯ä»£ç¢¼ - ä¸é¡¯ç¤ºä¸‹è¼‰é€£çµçµ¦ä½¿ç”¨è€…
console.log('ğŸš€ è¼‰å…¥ç°¡åŒ–ç‰ˆå‰ç«¯ä»£ç¢¼');

const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const fileInfo = document.getElementById('fileInfo');
const fileName = document.getElementById('fileName');
const fileSize = document.getElementById('fileSize');
const progressFill = document.getElementById('progressFill');
const status = document.getElementById('status');
const uploadBtn = document.getElementById('uploadBtn');
const cancelBtn = document.getElementById('cancelBtn');
const errorMessage = document.getElementById('errorMessage');
const successMessage = document.getElementById('successMessage');

let selectedFile = null;
let liffUserId = null;

// LIFF åˆå§‹åŒ–
async function initializeLiff() {
    try {
        console.log('ğŸ”§ åˆå§‹åŒ– LIFF...');
        await liff.init({ liffId: '2007898038-DLkNoLpM' });
        
        if (liff.isLoggedIn()) {
            const profile = await liff.getProfile();
            liffUserId = profile.userId;
            console.log('ğŸ‘¤ LIFF ç”¨æˆ¶:', profile.displayName, liffUserId);
        } else {
            console.log('âŒ LIFF æœªç™»å…¥');
            liff.login();
        }
    } catch (error) {
        console.error('âŒ LIFF åˆå§‹åŒ–å¤±æ•—:', error);
    }
}

function showError(message) {
    console.error('âŒ', message);
    errorMessage.textContent = message;
    errorMessage.style.display = 'block';
    successMessage.style.display = 'none';
}

function showSuccess(message) {
    console.log('âœ…', message);
    successMessage.textContent = message;
    successMessage.style.display = 'block';
    errorMessage.style.display = 'none';
}

// é»æ“Šä¸Šå‚³
uploadArea.addEventListener('click', () => {
    fileInput.click();
});

// æª”æ¡ˆé¸æ“‡
fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
    }
});

// æ‹–æ‹½æ”¯æ´
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    if (e.dataTransfer.files.length > 0) {
        handleFile(e.dataTransfer.files[0]);
    }
});

function handleFile(file) {
    console.log('ğŸ“ é¸æ“‡æª”æ¡ˆ:', file.name, formatFileSize(file.size));
    
    // æª”æ¡ˆé¡å‹æª¢æŸ¥
    const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
    const allowedExts = ['.pdf', '.doc', '.docx'];
    const fileExt = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
    
    if (!allowedTypes.includes(file.type) && !allowedExts.includes(fileExt)) {
        showError('ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ï¼Œè«‹ä¸Šå‚³ PDFã€DOC æˆ– DOCX æª”æ¡ˆ');
        return;
    }
    
    // æª”æ¡ˆå¤§å°æª¢æŸ¥
    if (file.size > 10 * 1024 * 1024) {
        showError('æª”æ¡ˆå¤ªå¤§ï¼Œè«‹é¸æ“‡å°æ–¼ 10MB çš„æª”æ¡ˆ');
        return;
    }
    
    selectedFile = file;
    fileName.textContent = file.name;
    fileSize.textContent = formatFileSize(file.size);
    
    fileInfo.classList.add('show');
    uploadBtn.textContent = 'é–‹å§‹ä¸Šå‚³';
    uploadBtn.disabled = false;
    cancelBtn.style.display = 'block';
    
    status.textContent = 'æº–å‚™ä¸Šå‚³...';
    progressFill.style.width = '0%';
    
    // æ¸…é™¤ä¹‹å‰çš„è¨Šæ¯
    errorMessage.style.display = 'none';
    successMessage.style.display = 'none';
}

// ä¸Šå‚³æŒ‰éˆ•
uploadBtn.addEventListener('click', () => {
    if (selectedFile) {
        uploadFile();
    } else {
        fileInput.click();
    }
});

// å–æ¶ˆæŒ‰éˆ•
cancelBtn.addEventListener('click', () => {
    selectedFile = null;
    fileInfo.classList.remove('show');
    uploadBtn.textContent = 'é¸æ“‡æª”æ¡ˆ';
    uploadBtn.disabled = true;
    cancelBtn.style.display = 'none';
    fileInput.value = '';
    errorMessage.style.display = 'none';
    successMessage.style.display = 'none';
});

// ç°¡åŒ–çš„ä¸Šå‚³å‡½æ•¸
async function uploadFile() {
    if (!selectedFile) {
        showError('æ²’æœ‰é¸æ“‡æª”æ¡ˆ');
        return;
    }

    console.log('ğŸ“¤ é–‹å§‹ä¸Šå‚³æª”æ¡ˆ:', selectedFile.name);
    console.log('ğŸ‘¤ ç”¨æˆ¶ ID:', liffUserId);
    
    uploadBtn.disabled = true;
    uploadBtn.textContent = 'è™•ç†ä¸­...';
    status.textContent = 'æ­£åœ¨ä¸Šå‚³ä¸¦è½‰æ›æª”æ¡ˆ...';
    
    // é€²åº¦å‹•ç•«
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += Math.random() * 8 + 3; // ç¨å¾®æ…¢ä¸€é»ï¼Œå› ç‚ºè¦è½‰æ›
        if (progress > 90) progress = 90;
        progressFill.style.width = progress + '%';
    }, 500);
    
    try {
        // æº–å‚™è¡¨å–®è³‡æ–™
        const formData = new FormData();
        formData.append('file', selectedFile);
        
        // å¦‚æœæœ‰ LINE ç”¨æˆ¶ IDï¼Œä¸€ä½µé€å‡º
        if (liffUserId) {
            formData.append('userId', liffUserId);
        }
        
        console.log('ğŸŒ ç™¼é€è«‹æ±‚åˆ° /api/upload');
        
        // å»ºç«‹å¸¶æœ‰è¶…æ™‚çš„è«‹æ±‚ï¼ˆå¢åŠ æ™‚é–“å› ç‚ºè¦è½‰æ›æª”æ¡ˆï¼‰
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 60000); // 60ç§’è¶…æ™‚
        
        // ç™¼é€è«‹æ±‚
        const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData,
            signal: controller.signal,
            // è®“ç€è¦½å™¨è‡ªå‹•è¨­ç½® Content-Type ç‚º multipart/form-data
        });
        
        clearTimeout(timeoutId);
        
        console.log('ğŸ“¡ æ”¶åˆ°å›æ‡‰:');
        console.log('  ç‹€æ…‹:', response.status, response.statusText);
        console.log('  Content-Type:', response.headers.get('content-type'));
        
        // å®Œæˆé€²åº¦æ¢
        clearInterval(progressInterval);
        progressFill.style.width = '100%';
        
        // è®€å–å›æ‡‰
        const responseText = await response.text();
        console.log('ğŸ“„ å›æ‡‰å…§å®¹é•·åº¦:', responseText.length);
        
        if (!responseText.trim()) {
            throw new Error('æœå‹™å™¨è¿”å›ç©ºå›æ‡‰');
        }
        
        // æª¢æŸ¥ HTTP ç‹€æ…‹
        if (!response.ok) {
            let errorMsg = `HTTP ${response.status}: ${response.statusText}`;
            try {
                const errorData = JSON.parse(responseText);
                errorMsg = errorData.error || errorMsg;
            } catch (e) {
                errorMsg = responseText.substring(0, 100) || errorMsg;
            }
            throw new Error(errorMsg);
        }
        
        // è§£æ JSON
        let result;
        try {
            result = JSON.parse(responseText);
            console.log('âœ… è§£ææˆåŠŸ:', result);
        } catch (jsonError) {
            console.error('âŒ JSON è§£æå¤±æ•—:', jsonError);
            console.error('åŸå§‹å…§å®¹:', responseText.substring(0, 200));
            throw new Error('æœå‹™å™¨å›æ‡‰æ ¼å¼éŒ¯èª¤');
        }
        
        // æª¢æŸ¥è™•ç†çµæœ
        if (result.success) {
            console.log('ğŸ‰ æª”æ¡ˆè™•ç†æˆåŠŸ!');
            status.textContent = 'è½‰æ›å®Œæˆï¼';
            uploadBtn.textContent = 'è™•ç†å®Œæˆ';
            uploadBtn.style.background = 'linear-gradient(135deg, #93c5a1, #7fb78a)';
            
            let successMsg = `æª”æ¡ˆ "${result.fileName}" è™•ç†å®Œæˆï¼`;
            
            if (result.n8nNotified) {
                successMsg += '\nâœ… å·²ç™¼é€è™•ç†çµæœ';
            } else {
                successMsg += '\nâš ï¸ è™•ç†å®Œæˆä½†é€šçŸ¥ç™¼é€å¤±æ•—';
            }
            
            showSuccess(successMsg);
            
            // 5ç§’å¾Œé‡ç½®ä»‹é¢
            setTimeout(() => {
                resetInterface();
            }, 5000);
            
        } else {
            throw new Error(result.error || 'æª”æ¡ˆè™•ç†å¤±æ•—ï¼Œè«‹é‡è©¦');
        }
        
    } catch (error) {
        console.error('âŒ è™•ç†éŒ¯èª¤:', error);
        
        clearInterval(progressInterval);
        progressFill.style.width = '0%';
        
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'é‡è©¦ä¸Šå‚³';
        uploadBtn.style.background = '';
        status.textContent = 'è™•ç†å¤±æ•—';
        
        let errorMsg = error.message;
        if (error.name === 'AbortError') {
            errorMsg = 'è™•ç†è¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå¾Œé‡è©¦';
        }
        
        showError(errorMsg);
    }
}

// é‡ç½®ä»‹é¢
function resetInterface() {
    selectedFile = null;
    fileInfo.classList.remove('show');
    uploadBtn.textContent = 'é¸æ“‡æª”æ¡ˆ';
    uploadBtn.disabled = true;
    uploadBtn.style.background = '';
    cancelBtn.style.display = 'none';
    fileInput.value = '';
    errorMessage.style.display = 'none';
    successMessage.style.display = 'none';
}

// æ ¼å¼åŒ–æª”æ¡ˆå¤§å°
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// æ¸¬è©¦æœå‹™å™¨é€£æ¥
async function testConnection() {
    try {
        console.log('ğŸ” æ¸¬è©¦æœå‹™å™¨é€£æ¥...');
        
        // æ¸¬è©¦å¥åº·æª¢æŸ¥
        const healthResponse = await fetch('/api/health');
        if (healthResponse.ok) {
            const healthData = await healthResponse.json();
            console.log('â¤ï¸ å¥åº·æª¢æŸ¥é€šé:', healthData);
            
            // æª¢æŸ¥è½‰æ›æ¨¡çµ„ç‹€æ…‹
            if (!healthData.modules.libreOffice || !healthData.modules.pdf2pic) {
                showError('æ–‡ä»¶è½‰æ›åŠŸèƒ½æœªå°±ç·’ï¼Œè«‹è¯ç¹«ç³»çµ±ç®¡ç†å“¡');
                return;
            }
        } else {
            throw new Error(`å¥åº·æª¢æŸ¥å¤±æ•—: ${healthResponse.status}`);
        }
        
        // æ¸¬è©¦åŸºæœ¬ API
        const testResponse = await fetch('/api/test');
        if (testResponse.ok) {
            const testData = await testResponse.json();
            console.log('ğŸ§ª æ¸¬è©¦ API é€šé:', testData);
        }
        
        console.log('âœ… æœå‹™å™¨é€£æ¥æ­£å¸¸');
        showSuccess('ç³»çµ±å·²å°±ç·’ï¼Œå¯ä»¥é–‹å§‹ä¸Šå‚³æª”æ¡ˆ');
        
        // 3ç§’å¾Œéš±è—æˆåŠŸè¨Šæ¯
        setTimeout(() => {
            successMessage.style.display = 'none';
        }, 3000);
        
    } catch (error) {
        console.error('âŒ æœå‹™å™¨é€£æ¥æ¸¬è©¦å¤±æ•—:', error);
        showError('æœå‹™å™¨é€£æ¥å¤±æ•—: ' + error.message);
    }
}

// é é¢åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', async () => {
    console.log('ğŸ“± é é¢è¼‰å…¥å®Œæˆ');
    
    // åˆå§‹åŒ– LIFF
    if (typeof liff !== 'undefined') {
        await initializeLiff();
    } else {
        console.warn('âš ï¸ LIFF SDK æœªè¼‰å…¥');
    }
    
    // å»¶é²æ¸¬è©¦é€£æ¥
    setTimeout(testConnection, 1000);
});

console.log('âœ… ç°¡åŒ–ç‰ˆå‰ç«¯ä»£ç¢¼è¼‰å…¥å®Œæˆ');
